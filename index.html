<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <link rel="stylesheet" href="css/leaflet.css" />
        <link rel="stylesheet" type="text/css" href="css/qgis2web.css">
        <link rel="stylesheet" href="css/label.css" />
        <link rel="stylesheet" href="css/MarkerCluster.css" />
        <link rel="stylesheet" href="css/MarkerCluster.Default.css" />
		<link rel="stylesheet" href="css/Leaflet.vector-markers.css">
		<link rel="stylesheet" href="css/map.css">		
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css">
        <!-- <link rel="stylesheet" href="http://k4r573n.github.io/leaflet-control-osm-geocoder/Control.OSMGeocoder.css" /> -->
        <script src="js/leaflet.js"></script>
        <script src="js/OSMBuildings-Leaflet.js"></script>
        <script src="js/leaflet-hash.js"></script>
        <script src="js/label.js"></script>
        <script src="js/Autolinker.min.js"></script>
        <script src="js/Control.OSMGeocoder.js"></script>
        <script src="js/leaflet.markercluster.js"></script>
		<script src="js/leaflet.vector-markers.js"></script>
		<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
		<script src="http://code.jquery.com/ui/1.8.18/jquery-ui.min.js" type="text/javascript"></script>	
		<link rel="stylesheet" href="http://code.jquery.com/ui/1.8.18/themes/base/jquery-ui.css" type="text/css" media="all" />
		<script src="js/jquery-ui-messageBox.js"></script>
		
        <style>

        </style>
        <title></title>
    </head>
    <body>
        <div id="map"></div>
		<div class="search_panel" id="search_panel">
			<a href="javascript:void(0);" id="search_slider" class="search_slider show"><img src="img/Search.png"></a>
			<p id="developer_text" class="developer_text"></p>
			<input href="javascript:void(0);" class="search_event" id="search_event">
			<br>
		</div>
		<div class="event_panel" id="event_panel">
			<a href="javascript:void(0);" id="event_slider" class="event_slider show"><img src="img/Search_close.png"></a>
			<div class="embeded_event" id="embeded_event">
			<div>
		</div>
        <script src="data/json_PunctefestivalWGS840.js"></script>
        <script>
		var startLatitude=0.0, startLongitude=0.0;
		var geojsonLayer;
		var marker;
		var eventPaneOpen=false;
		
        L.ImageOverlay.include({
            getBounds: function () {
                return this._bounds;
            }
        });
		
		//Initializarea obiectului de harta nivele de zoom, si extensia
        var map = L.map('map', {
            zoomControl:true, maxZoom:28, minZoom:1
        }).fitBounds([[44.7636192438,21.7002911194],[47.3754662077,28.6964999049]]);
		
        var hash = new L.Hash(map);
		
        map.attributionControl.addAttribution('<a href="https://github.com/tomchadwin/qgis2web" target="_blank">qgis2web</a><a>|</a><a href="http://project-osrm.org/" target="_blank">OSRM</a><a>|</a><a href="http://opendatacommons.org/licenses/odbl/" target="_blank">ODbL</a>');
        var feature_group = new L.featureGroup([]);
        var bounds_group = new L.featureGroup([]);
        var raster_group = new L.LayerGroup([]);
        /*var basemap0 = L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors,<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>',
            maxZoom: 28
        });*/
		//Stamen basemap
		/*var basemap0 = L.tileLayer('http://a.tile.stamen.com/toner/{z}/{x}/{y}.png', {
            attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>,<a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Mapdata: &copy; <a href="http://openstreetmap.org">OpenStreetMap</a>contributors,<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>',
            maxZoom: 28
        });*/
		//Stratul de baza de tip OSM black & white
		var basemap0 = L.tileLayer('http://{s}.www.toolserver.org/tiles/bw-mapnik/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>',
            maxZoom: 28
        });
        basemap0.addTo(map);
		
		//Stratul cu umbrire
		var hillUrl = 'http://{s}.tiles.wmflabs.org/hillshading/{z}/{x}/{y}.png';
		var hillAttribution = 'Hillshading: SRTM3 v2 (<a href="http://www2.jpl.nasa.gov/srtm/">NASA</a>)';
		var hill = new L.TileLayer(hillUrl, {minZoom: 10, maxZoom: 17, attribution: hillAttribution});
		map.addLayer(hill);
		
        var layerOrder = new Array();
        function stackLayers() {
            for (index = 0; index < layerOrder.length; index++) {
                map.removeLayer(layerOrder[index]);
                map.addLayer(layerOrder[index]);
            }
        }
        function restackLayers() {
            for (index = 0; index < layerOrder.length; index++) {
                layerOrder[index].bringToFront();
            }
        }
        layerControl = L.control.layers({},{},{collapsed:false});
		
		//Functia care creaza continutul pentru popup
        function pop_events(feature, layer) {
            var popupContent = '<table><tr><th scope="row">Nume</th><td>' +
			(feature.properties['Nume'] !== null ? Autolinker.link(String(feature.properties['Nume'])) : '') +
			'</td></tr><tr><th scope="row">Data</th><td>' +
			(feature.properties['Data'] !== null ? Autolinker.link(String(feature.properties['Data'])) : '') +
			'</td></tr><tr><td>' +
			(feature.properties['Logo_Ofici'] !== null ? Autolinker.link(String(feature.properties['Logo_Ofici'])) : '') +
			'</td></tr><tr><th scope="row">Pagina Oficială</th><td>' +
			(feature.properties['PaginaOfic'] !== null ? Autolinker.link(String(feature.properties['PaginaOfic'])) : '') +
			'</td><tr><th scope="row">Județ</th><td>' +
			(feature.properties['JUD'] !== null ? Autolinker.link(String(feature.properties['JUD'])) : '') +
			'</td></tr><tr><th scope="row">Localitate</th><td>' +
			(feature.properties['Localitate'] !== null ? Autolinker.link(String(feature.properties['Localitate'])) : '') +
			'</td></tr><tr><th scope="row">Adresa</th><td>' +
			(feature.properties['Adresa'] !== null ? Autolinker.link(String(feature.properties['Adresa'])) : '')+
			'</table><table></tr><tr></td><td><button class="button" onclick="getRoute('+feature.geometry.coordinates[0]+','+feature.geometry.coordinates[1]+')">Arată drumul către eveniment</button></td></tr><tr></td><td><button class="button" onclick="getEventInPane()">Despre eveniment in detalii</button></td></tr></table>';
            layer.bindPopup(popupContent);
        }
		
		//Functia pentru decodarea poliliniei
		function decodePolyline(str, precision) {
			var index = 0,
			lat = 0,
			lng = 0,
			coordinates = [],
			shift = 0,
			result = 0,
			byte = null,
			latitude_change,
			longitude_change,
			factor = Math.pow(10, precision || 5);

			while (index < str.length) {
				byte = null;
				shift = 0;
				result = 0;
				do {
					byte = str.charCodeAt(index++) - 63;
					result |= (byte & 0x1f) << shift;
					shift += 5;
				} while (byte >= 0x20);

				latitude_change = ((result & 1) ? ~(result >> 1) : (result >> 1));

				shift = result = 0;

				do {
					byte = str.charCodeAt(index++) - 63;
					result |= (byte & 0x1f) << shift;
					shift += 5;
				} while (byte >= 0x20);

				longitude_change = ((result & 1) ? ~(result >> 1) : (result >> 1));

				lat += latitude_change;
				lng += longitude_change;

				coordinates.push([lat / factor*0.1, lng / factor*0.1]);
			}

			return coordinates;
		};
		
		//Functia care transforma obiectul de intrare in geoJSON
		function polylineToGeoJSON(str, precision) {
			var coords = decodePolyline(str, precision);
			return {
				type: 'LineString',
				coordinates: flipped(coords)
			};
		};

		function flipped(coords) {
			var flipped = [];
			for (var i = 0; i < coords.length; i++) {
				flipped.push(coords[i].slice().reverse());
			}
			return flipped;
		}
		
		//Setare stil pentru start marker
		var startIconMarker = L.VectorMarkers.icon({
			iconSize:     [10, 20], // size of the icon
			shadowSize:   [10, 20],
			icon: 'home',
			prefix: 'fa',
			markerColor: '#89e200', 
			iconColor: '#eee8d5'
		});
		
		//Adaugare marker pentru locatia de start
		function onMapClick(e) {
			if (marker!=null){
				map.removeLayer(marker);
			};
			marker = new L.marker(e.latlng, {draggable:'true', icon: startIconMarker});
			marker.on('dragend', function(event){
				marker = event.target;
				var position = marker.getLatLng();
				marker.setLatLng(new L.LatLng(position.lat, position.lng),{draggable:'true'});
				map.panTo(new L.LatLng(position.lat, position.lng));
			});
			startLatitude=e.latlng.lat;
			startLongitude=e.latlng.lng;
			map.addLayer(marker);
		};

		map.on('click', onMapClick);
		
		//Functia pentru modificarea timpului din secunde in ore minute si secunde
		function toTimeString(inTime){		
			var hours=Math.floor(inTime/3600);
			var minutes=Math.floor((inTime-hours*3600)/60);
			var seconds=inTime-hours*3600-minutes*60;			
			return hours+' h, '+minutes+' m, '+seconds+' s';		
		}
		
		//Functia care aduce ruta
		function getRoute(finishLongitude, finishLatitiude){
			//Daca punctul de pornire nu este definit apare o fereastra de avertizare de altfel se calculeaza traseul
			if (startLatitude==0){
				$.showMessageBox({
					content:'Marcați locația de pornire',
					title:'Locația de pornire',
					type: 'warning',
					CloseButtonText:'Închide'
				});
			}else{
				//Daca exista un traseu calculat si afisat pe harta trebuie sa stergem inainte de a calcula traseul nou
				if (geojsonLayer!=null){
					map.removeLayer(geojsonLayer)
				};
				//Compunerea URL-ului cu cererea catre serverul de rutare 
				var requestURL='http://router.project-osrm.org/viaroute?loc='+startLatitude+','+startLongitude+'&loc='+finishLatitiude+','+finishLongitude+'&instructions=false';
				var xmlHttp = new XMLHttpRequest();
				xmlHttp.open( "GET", requestURL, false );
				xmlHttp.send( null );
				//Parsarea raspunsului in JSON
				var parsedData = JSON.parse(xmlHttp.response);
				//Decodarea raspunsului (a geometriei) si transformarea lui in geoJSON
				var geoJSON=polylineToGeoJSON(parsedData.route_geometry);
				//Mesajul cu detaliile traseului (timp si distanta)
				$.showMessageBox({
					content:'Distanța: '+parsedData.route_summary.total_distance/1000+' km <br> Timp: '+ toTimeString(parsedData.route_summary.total_time),
					title:'Traseul',
					CloseButtonText:'Închide'
				});
				//Adaugrea traseului pe harta
				geojsonLayer=L.geoJson(geoJSON).addTo(map);
			}
		}
		
		//Functia cu animatia panelului de evenimente
		function slideEventPane(show){
			if(show){
				diff = "+=470";
			}else{
				diff = "-=470";
			}
			//Miscarea panelului de evenimente
			$( ".event_panel" ).animate({
				left: diff
				}, 700, function() {
					//$(anchor).html(arrows).removeClass(removeClass).addClass(addClass);
				});
			//Miscarea butoanelor de zoom impreuna cu panelul de evenimente
			$( ".leaflet-bar" ).animate({
				left: diff
				}, 700, function() {
					//$(anchor).html(arrows).removeClass(removeClass).addClass(addClass);
				});
				
			//Miscarea scarii impreuna cu panelul de evenimente
			$( ".leaflet-bottom" ).animate({
				left: diff
				}, 700, function() {
					//$(anchor).html(arrows).removeClass(removeClass).addClass(addClass);
				});
		
		}
		
		//Functia care adauga datele in panelul de evenimente si apeleaza animatia panelului
		function getEventInPane(){
			if (!eventPaneOpen){
				slideEventPane(true);
				eventPaneOpen=true;
			}
			jQuery("#embeded_event").load("event_page/electric_castle.html");
		}
		
		//Functia care inchide panelul de evenimente
		$('.event_slider').click(function(){
			slideEventPane(false);
			eventPaneOpen=false;
		})
		
		//Adaugarea evenimentelor (entitate punct) ca si markere
        function doPointToLayerEvents(feature, latlng) {
            return L.marker(latlng)
        }
		
		//Citirea jsonului, mapare in popup si mapare afisare cu marker
        var json_PunctefestivalWGS840JSON = new L.geoJson(json_PunctefestivalWGS840, {
            onEachFeature: pop_events, 
            pointToLayer: doPointToLayerEvents
            });
		
		//Definirea clusterelor
        var cluster_groupEventsJSON = new L.MarkerClusterGroup({showCoverageOnHover: false});
        cluster_groupEventsJSON.addLayer(json_PunctefestivalWGS840JSON);

        layerOrder[layerOrder.length] = cluster_groupEventsJSON;

        bounds_group.addLayer(json_PunctefestivalWGS840JSON);
        cluster_groupEventsJSON.addTo(map);
        raster_group.addTo(map);
        feature_group.addTo(map);
		
		//Unealta de geocodare
        var osmGeocoder = new L.Control.OSMGeocoder({
            collapsed: false,
            position: 'topright',
            text: 'Search',
        });
        osmGeocoder.addTo(map);
        map.locate({setView: true, maxZoom: 16});
		
        function onLocationFound(e) {
            var radius = e.accuracy / 2;
            L.marker(e.latlng).addTo(map)
            .bindPopup("Ești la " + radius + " metrii față de acest punct")
            .openPopup();
            L.circle(e.latlng, radius).addTo(map);
        }
		
        map.on('locationfound', onLocationFound);
        L.control.scale({options: {position: 'bottomleft', maxWidth: 100, metric: true, imperial: false, updateWhenIdle: false}}).addTo(map);
        stackLayers();
        map.on('overlayadd', restackLayers);
		
		//Functia cu animatia pentru panelul de cautare
		$(function(){
			$('.search_slider').click(function(){
			var anchor = this;
			var removeClass = "hide";
			var addClass = "show";
			var diff = "-=470";
			var arrows = new Image(); 
			arrows.src="img/Search.png"
			arrows.width=23;
			if($(anchor).hasClass("show")){
				diff = "+=470";
				removeClass = "show";
				addClass="hide";
				arrows.src="img/Search_close.png"
			}
			$( ".search_panel" ).animate({
				right: diff
				}, 700, function() {
					$(anchor).html(arrows).removeClass(removeClass).addClass(addClass);
				});     
		});		

	});
        </script>
    </body>
</html>
